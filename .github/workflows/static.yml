<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°–µ–º–µ–π–Ω—ã–π —á–∞—Ç —Å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–µ–π</title>
    <style>
        /* –°—Ç–∏–ª–∏ —Ç–µ –∂–µ, —á—Ç–æ –∏ –≤ –ø—Ä–µ–¥—ã–¥—É—â–µ–π –≤–µ—Ä—Å–∏–∏, –º–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π */
        * {
            box-sizing: border-box;
            font-family: system-ui, -apple-system, 'Segoe UI', Roboto, sans-serif;
        }
        body {
            background: #f0f2f5;
            margin: 0;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .chat-container {
            width: 100%;
            max-width: 800px;
            height: 90vh;
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .header {
            background: #075e54;
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header h2 {
            margin: 0;
            font-weight: 500;
            font-size: 1.3rem;
        }
        .logout-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background 0.2s;
        }
        .logout-btn:hover {
            background: rgba(255,255,255,0.3);
        }
        .login-form {
            padding: 40px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            background: white;
        }
        .login-form h3 {
            margin: 0 0 10px;
            color: #075e54;
            text-align: center;
        }
        .login-form input {
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 25px;
            font-size: 1rem;
            outline: none;
            transition: border 0.2s;
        }
        .login-form input:focus {
            border-color: #075e54;
        }
        .login-form button {
            background: #075e54;
            color: white;
            border: none;
            padding: 12px;
            border-radius: 25px;
            font-size: 1rem;
            cursor: pointer;
            transition: background 0.2s;
        }
        .login-form button:hover {
            background: #054c44;
        }
        .error-message {
            color: #d32f2f;
            font-size: 0.9rem;
            text-align: center;
            margin-top: 5px;
        }
        .chat-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background: #e5ddd5;
        }
        .messages-area {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .message {
            background: white;
            padding: 10px 15px;
            border-radius: 18px;
            max-width: 80%;
            word-wrap: break-word;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            align-self: flex-start;
            position: relative;
        }
        .message.own {
            background: #dcf8c6;
            align-self: flex-end;
        }
        .message-header {
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
            color: #666;
            margin-bottom: 5px;
        }
        .message-author {
            font-weight: bold;
            color: #075e54;
        }
        .message-time {
            color: #999;
        }
        .message-text {
            font-size: 0.95rem;
            margin: 5px 0;
        }
        .message-image {
            max-width: 100%;
            max-height: 200px;
            border-radius: 10px;
            margin-top: 5px;
            cursor: pointer;
        }
        /* NEW: —Å—Ç–∏–ª–∏ –¥–ª—è –≤–∏–¥–µ–æ –≤ —Å–æ–æ–±—â–µ–Ω–∏–∏ */
        .message-video {
            max-width: 100%;
            max-height: 300px;
            border-radius: 10px;
            margin-top: 5px;
        }
        .input-area {
            background: #f0f0f0;
            padding: 15px;
            display: flex;
            gap: 10px;
            align-items: flex-end;
            border-top: 1px solid #ddd;
        }
        .input-area textarea {
            flex: 1;
            border: none;
            border-radius: 25px;
            padding: 12px 15px;
            font-size: 0.95rem;
            resize: none;
            max-height: 100px;
            outline: none;
            background: white;
        }
        .input-area input[type="file"] {
            display: none;
        }
        .attach-btn {
            background: #075e54;
            color: white;
            border: none;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }
        .attach-btn:hover {
            background: #054c44;
        }
        .send-btn {
            background: #075e54;
            color: white;
            border: none;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }
        .send-btn:hover {
            background: #054c44;
        }
        .photo-preview {
            max-width: 60px;
            max-height: 60px;
            border-radius: 8px;
            object-fit: cover;
            border: 2px solid #075e54;
        }
        /* NEW: —Å—Ç–∏–ª–∏ –¥–ª—è –ø—Ä–µ–≤—å—é –≤–∏–¥–µ–æ */
        .video-preview {
            max-width: 120px;
            max-height: 80px;
            border-radius: 8px;
            border: 2px solid #075e54;
            background: black;
        }
        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <div class="header">
            <h2>üë®‚Äçüë©‚Äçüëß‚Äçüë¶ –°–µ–º–µ–π–Ω—ã–π —á–∞—Ç</h2>
            <button id="logoutBtn" class="logout-btn hidden">–í—ã–π—Ç–∏</button>
        </div>

        <div id="loginBlock" class="login-form">
            <h3>–í—Ö–æ–¥ –≤ —á–∞—Ç</h3>
            <input type="text" id="loginName" placeholder="–í–∞—à–µ –∏–º—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ü–∞–ø–∞)" value="">
            <input type="password" id="loginPassword" placeholder="–ü–∞—Ä–æ–ª—å">
            <button id="loginBtn">–í–æ–π—Ç–∏</button>
            <div id="loginError" class="error-message"></div>
        </div>

        <div id="chatBlock" class="chat-main hidden">
            <div id="messages" class="messages-area"></div>
            <div class="input-area">
                <label for="photoInput" class="attach-btn" title="–ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —Ñ–æ—Ç–æ">üì∑</label>
                <input type="file" id="photoInput" accept="image/*">
                <!-- NEW: –∫–Ω–æ–ø–∫–∞ –¥–ª—è –≤–∏–¥–µ–æ -->
                <label for="videoInput" class="attach-btn" title="–ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å –≤–∏–¥–µ–æ">üìπ</label>
                <input type="file" id="videoInput" accept="video/*">
                <textarea id="messageText" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." rows="1"></textarea>
                <button id="sendBtn" class="send-btn">‚û§</button>
            </div>
            <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –ø—Ä–µ–≤—å—é —Ñ–æ—Ç–æ (–±—ã–ª —Ä–∞–Ω–µ–µ) -->
            <div id="previewContainer" style="padding: 0 15px 10px; display: none;">
                <img id="imagePreview" class="photo-preview" src="#" alt="–ü—Ä–µ–≤—å—é">
            </div>
            <!-- NEW: –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –ø—Ä–µ–≤—å—é –≤–∏–¥–µ–æ -->
            <div id="videoPreviewContainer" style="padding: 0 15px 10px; display: none;">
                <video id="videoPreview" class="video-preview" controls></video>
            </div>
        </div>
    </div>

    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

    <script>
        (function() {
            // üî• –ó–ê–ú–ï–ù–ò–¢–ï –≠–¢–ò –î–ê–ù–ù–´–ï –ù–ê –°–í–û–ò –ò–ó –ö–û–ù–°–û–õ–ò FIREBASE
            const firebaseConfig = {
                apiKey: "AIzaSyAyR1elICQIl2Co7T93OTGccqfocTKmhgM",
                authDomain: "familychat-4887e.firebaseapp.com",
                databaseURL: "https://familychat-4887e-default-rtdb.firebaseio.com/",
                projectId: "familychat-4887e",
                storageBucket: "familychat-4887e.firebasestorage.app",
                messagingSenderId: "914704805998",
                appId: "1:914704805998:web:4dc99877eae3a1ed72b67f"
            };

            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase
            firebase.initializeApp(firebaseConfig);
            const db = firebase.database();
            const messagesRef = db.ref('messages');

            // --- –ü–∞—Ä–∞–º–µ—Ç—Ä—ã ---
            const FAMILY_PASSWORD = 'family123';
            const USER_KEY = 'current_user';

            // --- –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ ---
            let currentUser = null;
            let selectedPhotoDataURL = null;
            // NEW: –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è DataURL –≤–∏–¥–µ–æ
            let selectedVideoDataURL = null;

            // --- –≠–ª–µ–º–µ–Ω—Ç—ã DOM ---
            const loginBlock = document.getElementById('loginBlock');
            const chatBlock = document.getElementById('chatBlock');
            const logoutBtn = document.getElementById('logoutBtn');
            const loginName = document.getElementById('loginName');
            const loginPassword = document.getElementById('loginPassword');
            const loginBtn = document.getElementById('loginBtn');
            const loginError = document.getElementById('loginError');
            const messagesDiv = document.getElementById('messages');
            const messageText = document.getElementById('messageText');
            const sendBtn = document.getElementById('sendBtn');
            const photoInput = document.getElementById('photoInput');
            const imagePreview = document.getElementById('imagePreview');
            const previewContainer = document.getElementById('previewContainer');
            // NEW: —ç–ª–µ–º–µ–Ω—Ç—ã –¥–ª—è –≤–∏–¥–µ–æ
            const videoInput = document.getElementById('videoInput');
            const videoPreview = document.getElementById('videoPreview');
            const videoPreviewContainer = document.getElementById('videoPreviewContainer');

            // --- –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ—Å—Å–∏–∏ ---
            function checkSession() {
                const savedUser = localStorage.getItem(USER_KEY);
                if (savedUser) {
                    currentUser = savedUser;
                    showChat();
                } else {
                    showLogin();
                }
            }

            function showLogin() {
                loginBlock.classList.remove('hidden');
                chatBlock.classList.add('hidden');
                logoutBtn.classList.add('hidden');
                currentUser = null;
            }

            function showChat() {
                loginBlock.classList.add('hidden');
                chatBlock.classList.remove('hidden');
                logoutBtn.classList.remove('hidden');
                messageText.value = '';
                clearPhotoPreview();
                clearVideoPreview(); // NEW: –æ—á–∏—â–∞–µ–º –∏ –≤–∏–¥–µ–æ
                // –ü–æ–¥–ø–∏—Å—ã–≤–∞–µ–º—Å—è –Ω–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π
                listenForMessages();
            }

            function clearPhotoPreview() {
                selectedPhotoDataURL = null;
                photoInput.value = '';
                previewContainer.style.display = 'none';
                imagePreview.src = '#';
            }

            // NEW: –æ—á–∏—Å—Ç–∫–∞ –ø—Ä–µ–≤—å—é –≤–∏–¥–µ–æ
            function clearVideoPreview() {
                selectedVideoDataURL = null;
                videoInput.value = '';
                videoPreviewContainer.style.display = 'none';
                videoPreview.src = '';
            }

            // --- –°–ª—É—à–∞–µ–º –Ω–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏ ---
            function listenForMessages() {
                messagesRef.off();
                messagesRef.limitToLast(200).on('value', (snapshot) => {
                    const data = snapshot.val();
                    if (!data) {
                        messagesDiv.innerHTML = '';
                        return;
                    }
                    const messagesArray = Object.entries(data).map(([id, msg]) => ({
                        id,
                        ...msg
                    })).sort((a, b) => (a.timestamp || 0) - (b.timestamp || 0));
                    renderMessages(messagesArray);
                });
            }

            // --- –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π ---
            function renderMessages(messages) {
                messagesDiv.innerHTML = '';
                messages.forEach(msg => {
                    const msgDiv = document.createElement('div');
                    msgDiv.className = 'message';
                    if (msg.author === currentUser) {
                        msgDiv.classList.add('own');
                    }

                    const header = document.createElement('div');
                    header.className = 'message-header';
                    const authorSpan = document.createElement('span');
                    authorSpan.className = 'message-author';
                    authorSpan.textContent = msg.author;
                    const timeSpan = document.createElement('span');
                    timeSpan.className = 'message-time';
                    if (msg.timestamp) {
                        const date = new Date(msg.timestamp);
                        timeSpan.textContent = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                    } else {
                        timeSpan.textContent = '';
                    }
                    header.appendChild(authorSpan);
                    header.appendChild(timeSpan);
                    msgDiv.appendChild(header);

                    if (msg.text) {
                        const textDiv = document.createElement('div');
                        textDiv.className = 'message-text';
                        textDiv.textContent = msg.text;
                        msgDiv.appendChild(textDiv);
                    }

                    if (msg.photo) {
                        const img = document.createElement('img');
                        img.className = 'message-image';
                        img.src = msg.photo;
                        img.alt = '–§–æ—Ç–æ';
                        img.addEventListener('click', () => window.open(msg.photo));
                        msgDiv.appendChild(img);
                    }

                    // NEW: –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤–∏–¥–µ–æ
                    if (msg.video) {
                        const video = document.createElement('video');
                        video.className = 'message-video';
                        video.src = msg.video;
                        video.controls = true;
                        video.preload = 'metadata';
                        video.addEventListener('click', () => window.open(msg.video));
                        msgDiv.appendChild(video);
                    }

                    messagesDiv.appendChild(msgDiv);
                });
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
            }

            // --- –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ Firebase ---
            // NEW: –¥–æ–±–∞–≤–ª–µ–Ω –ø–∞—Ä–∞–º–µ—Ç—Ä videoDataURL
            function sendMessage(text, photoDataURL, videoDataURL) {
                if (!currentUser) return;
                if (!text.trim() && !photoDataURL && !videoDataURL) return;

                const newMessage = {
                    author: currentUser,
                    text: text.trim() || '',
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                };

                if (photoDataURL) {
                    newMessage.photo = photoDataURL;
                }
                if (videoDataURL) {
                    newMessage.video = videoDataURL;
                }

                messagesRef.push(newMessage);
            }

            // --- –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ —Ñ–æ—Ç–æ ---
            photoInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (!file) {
                    clearPhotoPreview();
                    return;
                }
                if (!file.type.startsWith('image/')) {
                    alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ.');
                    clearPhotoPreview();
                    return;
                }
                // NEW: –µ—Å–ª–∏ –±—ã–ª–æ –≤—ã–±—Ä–∞–Ω–æ –≤–∏–¥–µ–æ, —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –µ–≥–æ
                if (selectedVideoDataURL) {
                    clearVideoPreview();
                }
                const reader = new FileReader();
                reader.onload = function(event) {
                    selectedPhotoDataURL = event.target.result;
                    imagePreview.src = selectedPhotoDataURL;
                    previewContainer.style.display = 'block';
                };
                reader.readAsDataURL(file);
            });

            // NEW: –æ–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ –≤–∏–¥–µ–æ
            videoInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (!file) {
                    clearVideoPreview();
                    return;
                }
                if (!file.type.startsWith('video/')) {
                    alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –≤–∏–¥–µ–æ—Ñ–∞–π–ª.');
                    clearVideoPreview();
                    return;
                }
                // –ï—Å–ª–∏ –±—ã–ª–æ –≤—ã–±—Ä–∞–Ω–æ —Ñ–æ—Ç–æ, —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –µ–≥–æ
                if (selectedPhotoDataURL) {
                    clearPhotoPreview();
                }
                const reader = new FileReader();
                reader.onload = function(event) {
                    selectedVideoDataURL = event.target.result;
                    videoPreview.src = selectedVideoDataURL;
                    videoPreviewContainer.style.display = 'block';
                };
                reader.readAsDataURL(file);
            });

            // --- –û—Ç–ø—Ä–∞–≤–∫–∞ –ø–æ –∫–Ω–æ–ø–∫–µ –∏–ª–∏ Enter ---
            function handleSend() {
                const text = messageText.value;
                // –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: –µ—Å–ª–∏ –µ—Å—Ç—å –∏ —Ñ–æ—Ç–æ, –∏ –≤–∏–¥–µ–æ, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –≤–∏–¥–µ–æ (–æ—á–∏—Å—Ç–∏–≤ —Ñ–æ—Ç–æ)
                // –Ω–æ —Å–µ–π—á–∞—Å –º—ã –∏—Ö –≤–∑–∞–∏–º–æ–∏—Å–∫–ª—é—á–∞–µ–º –ø—Ä–∏ –≤—ã–±–æ—Ä–µ, –ø–æ—ç—Ç–æ–º—É –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –æ–±–∞
                if (!text.trim() && !selectedPhotoDataURL && !selectedVideoDataURL) return;
                sendMessage(text, selectedPhotoDataURL, selectedVideoDataURL);
                messageText.value = '';
                clearPhotoPreview();
                clearVideoPreview(); // NEW
            }

            messageText.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    handleSend();
                }
            });

            sendBtn.addEventListener('click', handleSend);

            // --- –í—Ö–æ–¥ ---
            loginBtn.addEventListener('click', function() {
                const name = loginName.value.trim();
                const password = loginPassword.value.trim();
                if (!name) {
                    loginError.textContent = '–í–≤–µ–¥–∏—Ç–µ –∏–º—è';
                    return;
                }
                if (password !== FAMILY_PASSWORD) {
                    loginError.textContent = '–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å';
                    return;
                }
                currentUser = name;
                localStorage.setItem(USER_KEY, name);
                showChat();
                loginError.textContent = '';
                loginPassword.value = '';
            });

            // --- –í—ã—Ö–æ–¥ ---
            logoutBtn.addEventListener('click', function() {
                localStorage.removeItem(USER_KEY);
                messagesRef.off();
                showLogin();
            });

            // –°—Ç–∞—Ä—Ç
            checkSession();
        })();
    </script>
</body>
</html>
